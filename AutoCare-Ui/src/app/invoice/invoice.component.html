<main class="wrap">
  <section class="grid">
    <div class="card" style="grid-column:1 / -1;">
      <h2>Quản lý hóa đơn</h2>
      <p class="muted">
        Theo dõi và tạo mới các hóa đơn dịch vụ.
        Mỗi hóa đơn có thể xuất mã QR ký số điện tử để xác thực.
      </p>

      <div class="toolbar">
        <button class="btn" (click)="openCreateForm()">+ Tạo hóa đơn</button>
        <input type="text" class="input" placeholder="Tìm kiếm hóa đơn..."
               [(ngModel)]="searchTerm" (input)="filterInvoices()"/>
      </div>

      <table class="table">
        <thead>
        <tr>
          <th>ID</th>
          <th>Khách hàng</th>
          <th>Dịch vụ</th>
          <th>Ngày</th>
          <th>Tổng tiền (₫)</th>
          <th>Trạng thái</th>
          <th>QR</th>
          <th>Thao tác</th>
        </tr>
        </thead>
        <tbody>
          @for (i of filteredInvoices; track i.id) {
            <tr>
              <td>#{{ i.id }}</td>
              <td>{{ i.customer }}</td>
              <td>{{ i.service }}</td>
              <td>{{ i.date }}</td>
              <td>{{ i.total | number }}</td>
              <td>
                <span class="status"
                      [ngClass]="{
                        'ok': i.status === 'paid',
                        'warn': i.status === 'pending',
                        'danger': i.status === 'cancelled'
                      }">
                  {{ i.status }}
                </span>
              </td>
              <td>
                <button class="btn small" (click)="generateQR(i)">QR</button>
              </td>
              <td>
                <button class="btn small" (click)="editInvoice(i)">Sửa</button>
                <button class="btn small danger" (click)="deleteInvoice(i)">Xóa</button>
              </td>
            </tr>
          } @empty {
            <tr>
              <td colspan="8" style="text-align:center; padding:20px; color:#666;">
                Không tìm thấy hóa đơn nào.
              </td>
            </tr>
          }
        </tbody>
      </table>
    </div>
  </section>

  @if (showForm) {
    <section class="modal-backdrop">
      <div class="modal">
        <h3>{{ editMode ? 'Cập nhật hóa đơn' : 'Thêm hóa đơn mới' }}</h3>
        <form (ngSubmit)="saveInvoice()">
          <label>Khách hàng <input class="input" [(ngModel)]="form.customer" name="customer" required/></label>
          <label>Dịch vụ <input class="input" [(ngModel)]="form.service" name="service" required/></label>
          <label>Tổng tiền <input class="input" type="number" [(ngModel)]="form.total" name="total" required/></label>
          <label>Trạng thái
            <select class="select" [(ngModel)]="form.status" name="status">
              <option value="paid">paid</option>
              <option value="pending">pending</option>
              <option value="cancelled">cancelled</option>
            </select>
          </label>
          <div class="form-actions">
            <button class="btn" type="submit">Lưu</button>
            <button class="btn" type="button" (click)="closeForm()">Hủy</button>
          </div>
        </form>
      </div>
    </section>
  }

  @if (showQR) {
    <section class="modal-backdrop">
      <div class="modal qr">
        <h3>Mã QR Hóa đơn</h3>
        <img [src]="qrImageData" alt="QR" class="qr-image"/>
        <div class="form-actions">
          <button class="btn" (click)="downloadQR()">Tải về</button>
          <button class="btn" (click)="closeQR()">Đóng</button>
        </div>
      </div>
    </section>
  }
</main>
